version: 2

models:
  - name: web_events_fact
    description: Web Events Fact Table for Star

    meta:
        contains_pii: false
        owner: Data Analytics
        subject_matter_expert: Rob Hill

    columns:
      - name: web_event_fact_wid
        description: Primary Key generated by the data warehouse
        tests:
          - unique
          - not_null
    
      - name: order_wid
        description: Surrogate key generated by the data warehouse, foreign key tp orders.order_wid
        tests: 
          - relationships:
              to: ref('orders')
              field: order_wid   

      - name: product_wid
        description: Surrogate key generated by the data warehouse, foreign key tp products.product_wid
        tests: 
          - relationships:
              to: ref('products')
              field: product_wid   

      - name: web_event_wid
        description: Surrogate key generated by the data warehouse, foreign key tp web_events.web_event_wid
        tests: 
          - relationships:
              to: ref('web_events')
              field: web_event_wid  

    metrics:
      - name: total_page_views
        label: page_views
        model: ref('web_events_fact')
        description: "The count of `page` web events"
    
        calculation_method: count
        expression: web_event_id
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign
        
        filters:
          - field: web_event_name
            operator: '='
            value: 'page'

      - name: total_web_sessions
        label: web_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions"
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign
          
          
      - name: total_bounced_web_sessions
        label: bounced_sessions
        model: ref('web_events_fact')
        description: "Count of web sessions where total `page` events is less than or equal to 1"
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign
        
        filters:
          - field: total_page_views
            operator: '<='
            value: 1

      - name: total_web_users
        label: users
        model: ref('web_events_fact')
        description: "The distinct count of users in web sessions"
    
        calculation_method: count distinct
        expression: web_session_user
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: bounce_rate
        label: bounce_rate
        model: ref('web_events_fact')
        description: "The Total Bounced Web Sessions divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_bounced_web_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: total_product_viewed_sessions
        label: product_viewed_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions where product was viewed"
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

        filters:
          - field: web_event_name
            operator: '='
            value: 'product_viewed'

      - name: total_product_added_sessions
        label: product_added_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions where product was added"
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

        filters:
          - field: web_event_name
            operator: '='
            value: 'product_added'

      - name: total_checkout_step_viewed_sessions
        label: checkout_step_viewed_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions where checkout_step was viewed"
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

        filters:
          - field: web_event_name
            operator: '='
            value: 'checkout_step_viewed'

      - name: total_email_sign_up_sessions
        label: email_sign_up_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions with email_sign_up event name "
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

        filters:
          - field: web_event_name
            operator: '='
            value: 'email_sign_up'
      
      - name: total_order_completed_sessions
        label: order_completed_sessions
        model: ref('web_events_fact')
        description: "The count of web sessions with order_completed event name "
    
        calculation_method: count distinct
        expression: web_session_wid
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

        filters:
          - field: web_event_name
            operator: '='
            value: 'order_completed'

      - name: product_view_rate
        label: product_view_rate
        model: ref('web_events_fact')
        description: "The total web sessions that include a `product_viewed` event divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_product_viewed_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: add_to_cart_rate
        label: add_to_cart_rate
        model: ref('web_events_fact')
        description: "The total web sessions that include a `product_added` event divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_product_added_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: checkout_rate
        label: checkout_rate
        model: ref('web_events_fact')
        description: "The total web sessions that include a `checkout_step_viewed` event divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_checkout_step_viewed_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: signup_rate
        label: signup_rate
        model: ref('web_events_fact')
        description: "The total web sessions that include a `email_sign_up` event divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_email_sign_up_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign

      - name: conversion_rate
        label: conversion_rate
        model: ref('web_events_fact')
        description: "The total web sessions that include a `order_completed` event divided by Total Web Sessions"
    
        calculation_method: derived
        expression: total_order_completed_sessions / total_web_sessions
    
        dimensions:
          - web_session_start_time
          - web_session_landing_page_url
          - web_session_medium
          - web_session_source
          - web_session_campaign